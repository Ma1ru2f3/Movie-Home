<!doctype html>

<html lang="bn">    
<head>    
  <meta charset="utf-8" />    
  <meta name="viewport" content="width=device-width,initial-scale=1" />    
  <title>üé¨ Bangla Video Hub</title>    
  <script src="https://accounts.google.com/gsi/client" async defer></script>    
  <style>    
    :root{    
      --bg1: linear-gradient(135deg,#fff7f0 0%, #fffef6 50%, #f0fbff 100%);    
      --card: rgba(255,255,255,0.9);    
      --muted: #6b7280;    
      --accent: linear-gradient(90deg,#fb923c,#f97316);    
      --rounded: 14px;    
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;    
    }    
    html,body{height:100%;margin:0;background:var(--bg1);color:#0f172a}    
    .container{max-width:1100px;margin:0 auto;padding:18px}    
    header{position:sticky;top:0;background:rgba(255,255,255,0.6);backdrop-filter:blur(4px);border-bottom:1px solid rgba(255,255,255,0.6)}    
    .hdr{display:flex;align-items:center;gap:12px;padding:14px 0}    
    .logo{font-size:26px}    
    .site-title{font-weight:800;font-size:18px}    
    .site-sub{font-size:12px;color:var(--muted)}    
    nav{display:flex;gap:8px;padding:10px 0}    
    .tab{padding:8px 14px;border-radius:999px;background:rgba(255,255,255,0.8);font-weight:600;cursor:pointer;border:1px solid rgba(0,0,0,0.04)}    
    .tab.active{background:white;box-shadow:0 4px 12px rgba(2,6,23,0.06)}    
    main{padding:18px 0}    
    .grid{display:grid;gap:14px}    
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}    
    .card{background:var(--card);border-radius:var(--rounded);overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,0.06)}    
    .aspect-video{background:#0f172a;color:white;position:relative;padding-top:56.25%}    
    .aspect-video iframe,.aspect-video video{position:absolute;left:0;top:0;width:100%;height:100%;border:0}    
    .card-body{padding:12px}    
    .meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}    
    input[type="text"],textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(2,6,23,0.06);outline:none;background:white}    
    button{cursor:pointer;border:0;padding:8px 12px;border-radius:10px;font-weight:700}    
    .btn-primary{background:linear-gradient(90deg,#60a5fa,#7c3aed);color:white}    
    .btn-emerald{background:linear-gradient(90deg,#34d399,#10b981);color:white}    
    .btn-red{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}    
    .muted{color:var(--muted)}    
    .tiny{font-size:12px}    
    .row{display:flex;gap:12px;align-items:center}    
    .col{display:flex;flex-direction:column;gap:8px}    
    .progress-wrap{height:10px;background:rgba(0,0,0,0.06);border-radius:999px;overflow:hidden}    
    .progress-bar{height:100%;background:linear-gradient(90deg,#34d399,#f59e0b);width:0%}    
    .owner-block{padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbf7ef);border:1px dashed rgba(0,0,0,0.03)}    
    footer{padding:18px 0;text-align:center;color:var(--muted);font-size:13px}    
    .searchbar{display:flex;gap:8px}    
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#fff,#fff);border:1px solid rgba(0,0,0,0.04);font-weight:600}    
    .small-muted{font-size:12px;color:var(--muted)}    
    @media (max-width:800px){ .grid.cols-2{grid-template-columns:1fr} .row{flex-direction:column;align-items:stretch} nav{overflow:auto} }    
  </style>  
</head>    
<body>    
  <header>    
    <div class="container hdr">    
      <div class="logo">üé¨</div>    
      <div>    
        <div class="site-title" id="siteName">Bangla Video Hub</div>    
        <div class="site-sub" id="siteAbout">Video discovery with Google + SheetDB</div>    
      </div>    
      <div style="flex:1"></div>    
      <div id="gsi-signin"></div>    
    </div>    
    <div class="container" style="padding-bottom:10px">    
      <nav id="mainNav"></nav>    
    </div>    
  </header>    
  <main class="container">    
    <div id="paneHome" class="pane">    
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px">    
        <div class="col">    
          <div style="font-weight:800">üè† Home</div>    
          <div class="small-muted">Latest uploaded videos appear here automatically</div>    
        </div>    
        <div class="searchbar" style="max-width:520px;width:100%">    
          <input id="searchInput" type="text" placeholder="üîé Search by title..." />    
          <div class="chip" id="resultCount">0</div>    
        </div>    
      </div>  
      <div id="videosGrid" class="grid cols-2"></div>    
    </div>    
    <div id="paneSearch" class="pane" style="display:none">    
      <div style="font-weight:800;margin-bottom:10px">üîç Search results</div>    
      <div id="searchResults" class="grid cols-2"></div>    
    </div>    
    <div id="paneHistory" class="pane" style="display:none">    
      <div style="font-weight:800;margin-bottom:10px">üïò History</div>    
      <div id="historyList" class="col"></div>    
    </div>    
    <div id="paneProfile" class="pane" style="display:none">    
      <div class="grid" style="grid-template-columns:1fr 360px;gap:14px">    
        <div class="col">    
          <div class="card">    
            <div class="card-body">    
              <div style="font-weight:800;margin-bottom:8px">üë§ Profile</div>    
              <div id="profileArea"></div>    
            </div>    
          </div>    
          <div style="height:14px"></div>    
          <div class="card">    
            <div class="card-body">    
              <div style="font-weight:800;margin-bottom:8px">üì£ Owner Info</div>    
              <div class="owner-block" id="ownerInfoBlock">    
                <div><strong id="ownerName">‚Äî</strong></div>    
                <div class="small-muted" id="ownerAbout">‚Äî</div>    
                <div class="small-muted">Contact: <span id="ownerContact">‚Äî</span></div>    
              </div>    
            </div>    
          </div>    
        </div>    
        <div class="col">    
          <div id="adminBlock" class="card" style="display:none">    
            <div class="card-body">    
              <div style="font-weight:800;margin-bottom:8px">üõ†Ô∏è Admin Dashboard</div>    
              <div style="font-weight:700">Upload Video</div>    
              <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px">    
                <input id="uploadTitle" type="text" placeholder="Title" />    
                <input id="uploadLink" type="text" placeholder="Video link (YouTube/Facebook/Drive/TikTok/MP4)" />    
                <input id="uploadCategory" type="text" placeholder="Category" />    
                <div class="row">    
                  <button id="btnUpload" class="btn-emerald">Upload</button>    
                  <div style="flex:1"></div>    
                </div>    
                <div class="progress-wrap"><div id="uploadProgress" class="progress-bar"></div></div>    
              </div>    
              <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(0,0,0,0.06)" />    
              <div style="font-weight:700">Owner Settings</div>    
              <div style="display:grid;gap:8px;margin-top:8px">    
                <input id="ownerNameInput" type="text" placeholder="Site name" />    
                <input id="ownerAboutInput" type="text" placeholder="Short about text" />    
                <input id="ownerContactInput" type="text" placeholder="Contact email/phone" />    
                <div class="row"><button id="btnOwnerSave" class="btn-primary">Save Owner Info</button></div>    
              </div>    
              <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(0,0,0,0.06)" />    
              <div style="font-weight:700">Manage Videos</div>    
              <div id="manageVideosBlock" style="max-height:220px;overflow:auto;margin-top:8px;border-radius:10px;background:white;padding:8px"></div>    
              <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(0,0,0,0.06)" />    
              <div style="font-weight:700">User List</div>    
              <div id="userListBlock" style="max-height:220px;overflow:auto;margin-top:8px;border-radius:10px;background:white;padding:8px"></div>    
            </div>    
          </div>    
          <div style="height:12px"></div>    
          <div class="card">    
            <div class="card-body">    
              <div style="font-weight:800;margin-bottom:8px">üîí Login Info</div>    
              <div class="small-muted">Sign in with Google to view dashboard and upload (admin).</div>    
              <div style="height:8px"></div>    
              <div id="gsi-small"></div>    
            </div>    
          </div>    
        </div>    
      </div>    
    </div>    
  </main>    
  <footer>    
    <div class="container">    
      Made with ‚ù§Ô∏è using Google Sign-In + SheetDB ¬∑ <span id="footerStatus">Ready</span>    
    </div>    
  </footer>  
  <script>    
    const CONFIG = {
      ADMIN_EMAIL: "mymaruf94@gmail.com",
      SHEETDB_API: "https://sheetdb.io/api/v1/8j681cv0tysp5",
      GOOGLE_CLIENT_ID: "36874627982-u6mhk7hmn0do1btuk7rs1p8tbnddne14.apps.googleusercontent.com"
    };

    // ---------- Helpers ----------
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const api = CONFIG.SHEETDB_API;
    const adminEmail = CONFIG.ADMIN_EMAIL;

    function toast(msg){
      console.log('TOAST:', msg);
      alert(msg);
    }

    function apiGet(sheet){
      return fetch(`${api}?sheet=${encodeURIComponent(sheet)}`).then(r=>r.json());
    }
    function apiPost(sheet, rowObj){
      return fetch(`${api}?sheet=${encodeURIComponent(sheet)}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ data: rowObj })
      }).then(r=>r.json());
    }
    function apiDelete(sheet, id){
      return fetch(`${api}/id/${encodeURIComponent(id)}?sheet=${encodeURIComponent(sheet)}`, {
        method: 'DELETE',
        headers: {'Content-Type':'application/json'}
      }).then(r=>r.json());
    }

    function rid(prefix='id'){ return `${prefix}_${Math.random().toString(36).slice(2,9)}${Date.now().toString().slice(-4)}` }

    function getEmbedSrc(link){
      try{
        const u = new URL(link);
        if(u.hostname.includes('youtube.com')){ const id = u.searchParams.get('v'); if(id) return `https://www.youtube.com/embed/${id}`; }
        if(u.hostname === 'youtu.be'){ const id = u.pathname.slice(1); if(id) return `https://www.youtube.com/embed/${id}`; }
        if(u.hostname.includes('drive.google.com')){ const parts = u.pathname.split('/'); const idx = parts.indexOf('d'); const id = idx>=0? parts[idx+1] : null; if(id) return `https://drive.google.com/file/d/${id}/preview`; }
        if(u.hostname.includes('facebook.com')){ return `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(link)}&show_text=false&width=560`; }
        if(u.hostname.includes('tiktok.com')){
            const parts = u.pathname.split('/');
            const videoId = parts[parts.length - 1] || parts[parts.length - 2];
            if(videoId) return `https://www.tiktok.com/embed/v2/${videoId}`;
        }
      }catch(e){}
      return null;
    }

    // ---------- State ----------
    let STATE = {
      videos: [],
      owner: {},
      user: JSON.parse(localStorage.getItem('bv_user') || 'null'),
      history: JSON.parse(localStorage.getItem('bv_history') || '[]')
    };

    // ---------- UI wiring ----------
    const navEl = qs('#mainNav');
    const tabs = [
      {key:'home',label:'üè† Home'},
      {key:'search',label:'üîç Search'},
      {key:'history',label:'üïò History'},
      {key:'profile',label:'üë§ Profile'}
    ];
    let activeTab = 'home';
    function renderNav(){
      navEl.innerHTML = '';
      tabs.forEach(t => {
        const btn = document.createElement('button');
        btn.className = 'tab' + (t.key===activeTab? ' active':'');
        btn.textContent = t.label;
        btn.onclick = ()=>{ setTab(t.key); }
        navEl.appendChild(btn);
      });
    }
    function setTab(k){
      activeTab = k; renderNav();
      qsa('.pane').forEach(p=>p.style.display='none');
      qs('#paneHome').style.display = (k==='home'?'block':'none');
      qs('#paneSearch').style.display = (k==='search'?'block':'none');
      qs('#paneHistory').style.display = (k==='history'?'block':'none');
      qs('#paneProfile').style.display = (k==='profile'?'block':'none');
      if(k==='profile'){ renderProfile(); }
    }

    // ---------- Fetch & render ----------
    async function loadInitial(){
      qs('#footerStatus').textContent = 'Loading...';
      try{
        const [videosRaw, ownerRaw] = await Promise.all([
          apiGet('videos').catch(()=>[]),
          apiGet('ownerInfo').catch(()=>[])
        ]);
        STATE.videos = (Array.isArray(videosRaw) ? videosRaw.map(r => ({
          id: r.id || r.ID || rid('vid'),
          title: r.title || r.Title || r.name || 'Untitled',
          link: r.link || r.Link || r.url || '',
          category: r.category || r.Category || r.cat || '',
          uploadedBy: r.uploadedBy || r.UploadedBy || '',
          uploadDate: r.uploadDate || r.UploadDate || ''
        })) : []);
        if(Array.isArray(ownerRaw)){
          let o = {};
          ownerRaw.forEach(r => { if(r.key) o[r.key] = r.value; });
          STATE.owner = o;
        } else STATE.owner = {};
        renderSiteHeader();
        renderVideosGrid();
        qs('#resultCount').textContent = STATE.videos.length;
        qs('#footerStatus').textContent = 'Ready';
        if(STATE.user && STATE.user.email === adminEmail){
            renderManageVideos();
        }
      }catch(e){
        qs('#footerStatus').textContent = 'Error loading';
        console.error(e);
      }
    }

    function renderSiteHeader(){
      qs('#siteName').textContent = STATE.owner.name || 'Bangla Video Hub';
      qs('#siteAbout').textContent = STATE.owner.about || 'Video discovery with Google + SheetDB';
      qs('#ownerName').textContent = STATE.owner.name || '‚Äî';
      qs('#ownerAbout').textContent = STATE.owner.about || '‚Äî';
      qs('#ownerContact').textContent = STATE.owner.contact || '‚Äî';
      qs('#ownerNameInput').value = STATE.owner.name || '';
      qs('#ownerAboutInput').value = STATE.owner.about || '';
      qs('#ownerContactInput').value = STATE.owner.contact || '';
    }

    function renderVideosGrid(){
      const el = qs('#videosGrid'); el.innerHTML = '';
      if(!STATE.videos.length){
        el.innerHTML = '<div style="padding:18px" class="card-body">No videos yet. Admin can upload from Profile ‚Üí Admin Dashboard.</div>';
        return;
      }
      STATE.videos.forEach(v=>{
        const card = document.createElement('div'); card.className='card';
        const embedSrc = getEmbedSrc(v.link);
        const playerHtml = embedSrc ? `<iframe src="${embedSrc}" allow="accelerometer; autoplay; encrypted-smedia; picture-in-picture" allowfullscreen></iframe>` : `<video controls><source src="${encodeURI(v.link)}"></video>`;
        card.innerHTML = `<div class="aspect-video">${playerHtml}</div>
          <div class="card-body">
            <div style="font-weight:700">${escapeHtml(v.title)}</div>
            <div class="meta" style="margin-top:8px">
              <div>${escapeHtml(v.category || 'General')}</div>
              <div style="flex:1"></div>
              <div class="tiny muted">by ${escapeHtml(v.uploadedBy||'‚Äî')}</div>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
              <button class="btn-primary" data-id="${v.id}">‚ñ∂Ô∏è Play</button>
              <button data-open class="small-muted">üîó Open</button>
              <div style="flex:1"></div>
              <div class="small-muted tiny">${v.uploadDate? new Date(v.uploadDate).toLocaleString() : ''}</div>
            </div>
          </div>`;
        card.querySelector('[data-open]').onclick = ()=> window.open(v.link,'_blank');
        card.querySelector('.btn-primary').onclick = async ()=>{ onPlay(v); };
        el.appendChild(card);
      });
    }

    qs('#searchInput').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      if (q.length > 0) {
          setTab('search');
          const res = STATE.videos.filter(v=> v.title.toLowerCase().includes(q));
          qs('#resultCount').textContent = res.length;
          renderSearchResults(res);
      } else {
          setTab('home');
      }
    });

    function renderSearchResults(list){
      const el = qs('#searchResults'); el.innerHTML = '';
      if(!list.length) el.innerHTML = '<div class="card-body">No results.</div>';
      list.forEach(v=>{
        const c = document.createElement('div'); c.className='card';
        const embedSrc = getEmbedSrc(v.link);
        const playerHtml = embedSrc ? `<iframe src="${embedSrc}" allowfullscreen></iframe>` : `<video controls><source src="${encodeURI(v.link)}"></video>`;
        c.innerHTML = `<div class="aspect-video">${playerHtml}</div>
          <div class="card-body">
            <div style="font-weight:700">${escapeHtml(v.title)}</div>
            <div class="meta" style="margin-top:8px">
              ${escapeHtml(v.category||'General')}
              <div style="flex:1"></div>
              <div class="tiny muted">${escapeHtml(v.uploadedBy||'‚Äî')}</div>
            </div>
          </div>`;
        c.querySelector('iframe,video').addEventListener('play', ()=> onPlay(v), {once:true});
        el.appendChild(c);
      });
    }

    function renderHistory(){
      const el = qs('#historyList'); el.innerHTML = '';
      if(!STATE.history.length){ el.innerHTML = '<div class="small-muted">No history yet.</div>'; return; }
      STATE.history.forEach(it=>{
        const r = document.createElement('div'); r.className='card';
        r.innerHTML = `<div class="card-body"><div style="font-weight:700">${escapeHtml(it.title)}</div><div class="small-muted tiny">${new Date(it.at).toLocaleString()}</div></div>`;
        el.appendChild(r);
      });
    }

    function renderProfile(){
      const area = qs('#profileArea'); area.innerHTML = '';
      if(!STATE.user){
        area.innerHTML = `<div id="gsi_container_small"></div><div style="margin-top:8px" class="small-muted">Sign in with Google to see profile & (if admin) the Admin Dashboard.</div>`;
        renderGSI('gsi_container_small');
        qs('#adminBlock').style.display = 'none';
        return;
      }
      const u = STATE.user;
      area.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
          ${u.picture?`<img src="${u.picture}" style="width:64px;height:64px;border-radius:12px;object-fit:cover">`:`<div style="width:64px;height:64px;border-radius:12px;background:#eee;display:flex;align-items:center;justify-content:center">üôÇ</div>`}
          <div>
            <div style="font-weight:800">${escapeHtml(u.name)}</div>
            <div class="small-muted">${escapeHtml(u.email)}</div>
            <div class="small-muted tiny">User ID: <code>${escapeHtml(u.localId)}</code></div>
          </div>
          <div style="flex:1"></div>
          <div><button id="btnSignOut" class="btn-primary">Sign out</button></div>
        </div>`;
      qs('#btnSignOut').onclick = ()=> signOut();

      if(u.email === adminEmail){
        qs('#adminBlock').style.display = 'block';
        loadUserList();
        renderManageVideos();
      } else {
        qs('#adminBlock').style.display = 'none';
      }
    }

    async function onPlay(video){
      STATE.history = [ {id:video.id, title:video.title, at:new Date().toISOString()}, ...STATE.history.filter(h=>h.id!==video.id) ].slice(0,100);
      localStorage.setItem('bv_history', JSON.stringify(STATE.history));
      renderHistory();
      try{
        await apiPost('history', { userId: STATE.user? STATE.user.localId : 'anon', videoId: video.id, watchedAt: new Date().toISOString() });
      }catch(e){ /* ignore */ }
    }

    qs('#btnUpload').addEventListener('click', async ()=>{
      if(!STATE.user || STATE.user.email !== adminEmail){ toast('Only admin can upload (sign in with admin email).'); return; }
      const title = qs('#uploadTitle').value.trim();
      const link = qs('#uploadLink').value.trim();
      const category = qs('#uploadCategory').value.trim();
      if(!title || !link){ toast('Title and Link required'); return; }
      const pb = qs('#uploadProgress'); pb.style.width = '5%';
      let p = 5; const iv = setInterval(()=>{ p = Math.min(95, p+8); pb.style.width = p+'%'; }, 180);
      try{
        const row = {
          id: rid('vid'),
          title, link, category,
          uploadedBy: STATE.user.email,
          uploadDate: new Date().toISOString()
        };
        await apiPost('videos', row);
        clearInterval(iv); pb.style.width = '100%';
        setTimeout(()=> pb.style.width = '0%', 500);
        qs('#uploadTitle').value=''; qs('#uploadLink').value=''; qs('#uploadCategory').value='';
        toast('Upload successful ‚Äî added to Home!');
        await loadInitial();
      }catch(e){
        clearInterval(iv); pb.style.width = '0%';
        console.error(e); toast('Upload failed');
      }
    });

    qs('#btnOwnerSave').addEventListener('click', async ()=>{
      if(!STATE.user || STATE.user.email !== adminEmail){ toast('Only admin can save owner info'); return; }
      const name = qs('#ownerNameInput').value.trim();
      const about = qs('#ownerAboutInput').value.trim();
      const contact = qs('#ownerContactInput').value.trim();
      try{
        await apiPost('ownerInfo', { key: 'name', value: name });
        await apiPost('ownerInfo', { key: 'about', value: about });
        await apiPost('ownerInfo', { key: 'contact', value: contact });
        toast('Owner info saved (appended). Refreshing...');
        await loadInitial();
      }catch(e){ console.error(e); toast('Failed saving owner info'); }
    });

    function renderManageVideos(){
      const out = qs('#manageVideosBlock');
      out.innerHTML = '';
      if(!STATE.videos.length){
        out.innerHTML = '<div class="small-muted">No videos to manage.</div>';
        return;
      }
      STATE.videos.forEach(v => {
        const d = document.createElement('div');
        d.style.padding = '8px';
        d.style.borderBottom = '1px solid rgba(0,0,0,0.04)';
        d.style.display = 'flex';
        d.style.alignItems = 'center';
        d.innerHTML = `<div style="flex:1;">
            <div style="font-weight:700">${escapeHtml(v.title)}</div>
            <div class="small-muted tiny">${escapeHtml(v.link)}</div>
          </div>
          <button class="btn-red" data-id="${v.id}">Delete</button>`;
        out.appendChild(d);
        d.querySelector('.btn-red').addEventListener('click', async () => {
          if (confirm(`Are you sure you want to delete "${v.title}"?`)) {
            try {
              toast(`Deleting video...`);
              await apiDelete('videos', v.id);
              toast('Video deleted successfully!');
              await loadInitial();
            } catch (e) {
              console.error(e);
              toast('Failed to delete video.');
            }
          }
        });
      });
    }

    async function loadUserList(){
      const out = qs('#userListBlock'); out.innerHTML = '<div class="small-muted">Loading‚Ä¶</div>';
      try{
        const users = await apiGet('users');
        out.innerHTML = '';
        if(!Array.isArray(users) || !users.length){ out.innerHTML = '<div class="small-muted">No users yet.</div>'; return; }
        users.forEach(u=>{
          const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(0,0,0,0.04)';
          d.innerHTML = `<div style="font-weight:700">${escapeHtml(u.name||'‚Äî')}</div><div class="small-muted">${escapeHtml(u.email||'‚Äî')} <span style="float:right" class="tiny">ID: <code>${escapeHtml(u.id||'‚Äî')}</code></span></div>`;
          out.appendChild(d);
        });
      }catch(e){ out.innerHTML = '<div class="small-muted">Failed loading users</div>'; }
    }

    let gsiInited = false;
    function renderGSI(containerId='gsi-signin'){
      if(!window.google || gsiInited) return;
      gsiInited = true;
      function handleCredentialResponse(response){
        try{
          const id_token = response.credential;
          const payload = JSON.parse(atob(id_token.split('.')[1]));
          const user = {
            name: payload.name,
            email: payload.email,
            picture: payload.picture,
            id_token,
            localId: rid('usr')
          };
          STATE.user = user;
          localStorage.setItem('bv_user', JSON.stringify(user));
          apiPost('users', { id: user.localId, name: user.name, email: user.email, createdAt: new Date().toISOString() }).catch(()=>{});
          renderProfile();
        }catch(e){ console.error('GSI parse error', e); }
      }

      window.google.accounts.id.initialize({
        client_id: CONFIG.GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });
      window.google.accounts.id.renderButton(document.getElementById('gsi-signin'), { theme:'filled_blue', size:'large', text:'signin_with' });
    }
    function signOut(){
      STATE.user = null;
      localStorage.removeItem('bv_user');
      renderProfile();
      toast('Signed out');
    }

    function renderGSI_small(){
      if(!window.google) return;
      const el = document.getElementById('gsi-small');
      if(!el) return;
      window.google.accounts.id.renderButton(el, { theme:'outline', size:'small', text:'signin_with' });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }

    (function init(){
      renderNav();
      setTab('home');
      const gsitime = setInterval(()=>{ if(window.google){ renderGSI(); clearInterval(gsitime); } }, 200);
      const gsitime2 = setInterval(()=>{ if(window.google && qs('#gsi_container_small')){ renderGSI('gsi_container_small'); clearInterval(gsitime2); } }, 200);

      loadInitial();
      renderHistory();
      if(STATE.user) renderProfile();
      qs('#searchInput').addEventListener('focus', ()=> setTab('search'));
    })();
  </script>  
</body>
</html>