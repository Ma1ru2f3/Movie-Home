<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MovieBox</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; }
nav { margin-bottom:20px; }
nav button { margin-right:10px; padding:10px 15px; }
#progress-container { width:100%; background:#eee; margin-top:10px; height:20px; }
#progress-bar { width:0%; height:100%; background:green; }
.video-card { margin-bottom:20px; }
.video-card video { width:300px; display:block; }
</style>
</head>
<body>

<nav>
  <button onclick="showSection('home')">Home</button>
  <button onclick="showSection('favorite')">Favorite</button>
  <button onclick="showSection('profile')">Profile</button>
</nav>

<div id="home" class="section"></div>
<div id="favorite" class="section" style="display:none;">Favorite videos coming soon</div>
<div id="profile" class="section" style="display:none;">
  <h3>Admin Login</h3>
  <input type="text" id="admin-user" placeholder="Username"><br><br>
  <input type="password" id="admin-pass" placeholder="Password"><br><br>
  <button id="login-btn">Login</button>

  <div id="upload-section" style="display:none; margin-top:20px;">
    <h3>Upload Video</h3>
    <input type="file" id="video-file"><br><br>
    <input type="text" id="video-title" placeholder="Enter video title"><br><br>
    <button id="upload-btn">Upload</button>
    <div id="progress-container" style="display:none;">
      <div id="progress-bar"></div>
    </div>
    <p id="upload-status"></p>
  </div>
</div>

<script>
let videos = [];
function showSection(sec){ 
  document.querySelectorAll('.section').forEach(s => s.style.display='none');
  document.getElementById(sec).style.display='block';
}

// Fetch videos from server
async function fetchVideos(){
  const res = await fetch("/videos");
  videos = await res.json();
  renderVideos();
}

// Render videos on Home
function renderVideos(){
  const home = document.getElementById("home");
  home.innerHTML = '';
  videos.forEach(v=>{
    const div = document.createElement("div");
    div.className = "video-card";
    div.innerHTML = `
      <h4>${v.title}</h4>
      <video src="${v.url}" controls></video>
      <button onclick="deleteVideo('${v.public_id}')">Delete</button>
    `;
    home.appendChild(div);
  });
}

// Delete video
async function deleteVideo(id){
  const form = new FormData();
  form.append("user","admin");
  form.append("pass","1234");
  form.append("public_id",id);
  await fetch("/delete", {method:"POST", body:form});
  fetchVideos();
}

// Admin login
document.getElementById("login-btn").addEventListener("click",()=>{
  const u = document.getElementById("admin-user").value;
  const p = document.getElementById("admin-pass").value;
  if(u==="admin" && p==="1234"){
    alert("Admin logged in");
    document.getElementById("upload-section").style.display="block";
  }else alert("Invalid credentials");
});

// Upload with progress
const uploadBtn = document.getElementById("upload-btn");
const fileInput = document.getElementById("video-file");
const titleInput = document.getElementById("video-title");
const progressBar = document.getElementById("progress-bar");
const progressContainer = document.getElementById("progress-container");
const uploadStatus = document.getElementById("upload-status");

uploadBtn.addEventListener("click", () => {
  const file = fileInput.files[0];
  const title = titleInput.value;
  if(!file) return alert("Select a video file");
  const formData = new FormData();
  formData.append("video",file);
  formData.append("title",title);
  formData.append("user","admin");
  formData.append("pass","1234");

  progressContainer.style.display="block";
  uploadStatus.innerText="Uploading...";

  const xhr = new XMLHttpRequest();
  xhr.open("POST","/upload");
  xhr.upload.onprogress = (e)=>{
    if(e.lengthComputable){
      const percent = Math.round((e.loaded/e.total)*100);
      progressBar.style.width = percent+"%";
    }
  };
  xhr.onload = ()=>{
    if(xhr.status===200){
      const data = JSON.parse(xhr.response);
      videos.push(data);
      renderVideos();
      uploadStatus.innerText="Uploaded Successfully ✅";
      setTimeout(()=>{
        progressContainer.style.display="none";
        progressBar.style.width="0%";
        uploadStatus.innerText="";
      },2000);
    }else uploadStatus.innerText="Upload Failed ❌";
  };
  xhr.send(formData);
});

fetchVideos();
</script>

</body>
</html>