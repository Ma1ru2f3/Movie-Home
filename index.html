<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Platform</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
.navbar { display:flex; background:#333; color:white; padding:10px; }
.navbar div { margin-right:20px; cursor:pointer; }
.container { padding:20px; }
video { width:100%; max-width:400px; margin:10px 0; }
#progress { width:100%; background:#ccc; height:20px; display:none; }
#progress-bar { width:0%; height:100%; background:green; }
</style>
</head>
<body>

<div class="navbar">
  <div id="homeBar">Home</div>
  <div id="searchBar">Search</div>
  <div id="favBar">Favourites</div>
  <div id="profileBar">Profile</div>
</div>

<div class="container" id="content">
  <h2>Welcome to Video Platform</h2>
</div>

<script>
const content = document.getElementById("content");
let videos = [];
let favs = [];

function renderHome() {
  content.innerHTML = "<h2>Home</h2>";
  videos.forEach(v=>{
    const div = document.createElement("div");
    div.innerHTML = `<h4>${v.title}</h4>
      <video controls src="${v.url}"></video>
      <button onclick="addFav('${v.filename}')">Fav</button>`;
    content.appendChild(div);
  });
}

function renderFav() {
  content.innerHTML = "<h2>Favourites</h2>";
  favs.forEach(v=>{
    const div = document.createElement("div");
    div.innerHTML = `<h4>${v.title}</h4>
      <video controls src="${v.url}"></video>`;
    content.appendChild(div);
  });
}

function renderSearch() {
  content.innerHTML = `<h2>Search</h2>
    <input type="text" id="searchInput" placeholder="Search video by title">
    <button onclick="doSearch()">Search</button>
    <div id="searchResults"></div>`;
}

function doSearch() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const resDiv = document.getElementById("searchResults");
  resDiv.innerHTML = "";
  videos.filter(v=>v.title.toLowerCase().includes(q)).forEach(v=>{
    const div = document.createElement("div");
    div.innerHTML = `<h4>${v.title}</h4>
      <video controls src="${v.url}"></video>`;
    resDiv.appendChild(div);
  });
}

function renderProfile() {
  content.innerHTML = `<h2>Profile / Admin</h2>
    <div id="loginDiv">
      <input type="text" id="user" placeholder="Username">
      <input type="password" id="pass" placeholder="Password">
      <button onclick="loginAdmin()">Login</button>
    </div>
    <div id="adminDiv" style="display:none;">
      <h3>Upload Video</h3>
      <input type="text" id="title" placeholder="Video Title"><br><br>
      <input type="file" id="videoFile"><br><br>
      <div id="progress"><div id="progress-bar"></div></div>
      <button onclick="uploadVideo()">Upload</button>
      <h3>Manage Videos</h3>
      <div id="adminVideos"></div>
    </div>`;
}

function addFav(filename){
  const v = videos.find(v=>v.filename===filename);
  if(!favs.includes(v)) favs.push(v);
  alert("Added to favourites!");
}

let isAdmin = false;

function loginAdmin(){
  const user = document.getElementById("user").value;
  const pass = document.getElementById("pass").value;
  fetch("/upload",{method:"POST", body: new FormData()})
  // just to check login
  fetch("/upload",{
    method:"POST",
    body:JSON.stringify({user,pass}),
    headers:{"Content-Type":"application/json"}
  }).then(res=>{
    if(res.status===401) alert("Unauthorized");
    else {
      isAdmin=true;
      document.getElementById("loginDiv").style.display="none";
      document.getElementById("adminDiv").style.display="block";
      loadAdminVideos();
    }
  });
}

function uploadVideo(){
  const file = document.getElementById("videoFile").files[0];
  const title = document.getElementById("title").value;
  if(!file){ alert("Select video"); return; }
  const formData = new FormData();
  formData.append("video",file);
  formData.append("title",title);
  formData.append("user","admin");
  formData.append("pass","1234");

  const progress = document.getElementById("progress");
  const bar = document.getElementById("progress-bar");
  progress.style.display="block";
  bar.style.width="0%";

  const xhr = new XMLHttpRequest();
  xhr.open("POST","/upload",true);
  xhr.upload.onprogress = e => {
    if(e.lengthComputable){
      const percent = (e.loaded/e.total)*100;
      bar.style.width = percent+"%";
    }
  };
  xhr.onload = ()=>{
    if(xhr.status===200){
      alert("Upload Success!");
      loadVideos();
      loadAdminVideos();
      progress.style.display="none";
    } else alert("Upload Failed");
  };
  xhr.send(formData);
}

function loadVideos(){
  fetch("/videos").then(r=>r.json()).then(data=>{
    videos = data;
  });
}

function loadAdminVideos(){
  const div = document.getElementById("adminVideos");
  div.innerHTML="";
  videos.forEach(v=>{
    const d = document.createElement("div");
    d.innerHTML = `<h4>${v.title}</h4>
      <video controls src="${v.url}"></video>
      <button onclick="deleteVideo('${v.filename}')">Delete</button>`;
    div.appendChild(d);
  });
}

function deleteVideo(filename){
  fetch("/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename,"user":"admin","pass":"1234"})})
  .then(r=>r.json()).then(res=>{
    alert("Deleted");
    loadVideos();
    loadAdminVideos();
  });
}

// Navbar events
document.getElementById("homeBar").onclick = ()=>renderHome();
document.getElementById("favBar").onclick = ()=>renderFav();
document.getElementById("searchBar").onclick = ()=>renderSearch();
document.getElementById("profileBar").onclick = ()=>renderProfile();

// Initial load
loadVideos();
</script>

</body>
</html>