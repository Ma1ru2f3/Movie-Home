<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <nav class="flex justify-around bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4">
    <button onclick="showPage('home')" class="font-bold">üè† Home</button>
    <button onclick="showPage('search')" class="font-bold">üîç Search</button>
    <button onclick="showPage('history')" class="font-bold">‚è≥ History</button>
    <button onclick="showPage('profile')" class="font-bold">üë§ Profile</button>
  </nav>

  <div id="pages" class="p-4">
    <div id="home" class="page">
      <h1 class="text-xl font-bold mb-4">üè† Home</h1>
      <div id="videoList" class="grid gap-4"></div>
    </div>

    <div id="search" class="page hidden">
      <h1 class="text-xl font-bold mb-4">üîç Search</h1>
      <input id="searchInput" type="text" placeholder="Search by title..." 
             class="p-2 border rounded w-full mb-4"
             onkeyup="searchVideos()">
      <div id="searchResults" class="grid gap-4"></div>
    </div>

    <div id="history" class="page hidden">
      <h1 class="text-xl font-bold mb-4">‚è≥ History</h1>
      <div id="historyList" class="grid gap-4"></div>
    </div>

    <div id="profile" class="page hidden">
      <h1 class="text-xl font-bold mb-4">üë§ Profile</h1>
      <div id="profileContent"></div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const ADMIN_EMAIL = "mymaruf94@gmail.com";
const SHEET_API = "https://sheetdb.io/api/v1/8j681cv0tysp5";
const GOOGLE_CLIENT_ID = "36874627982-u6mhk7hmn0do1btuk7rs1p8tbnddne14.apps.googleusercontent.com";

let currentUser = null;
let videos = [];
let historyData = [];

/* ================= NAVIGATION ================= */
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* ================= EMBED HELPER ================= */
function getEmbedUrl(url) {
  if (url.includes("youtube.com/watch?v=")) {
    const videoId = url.split("v=")[1].split("&")[0];
    return `https://www.youtube.com/embed/${videoId}`;
  }
  if (url.includes("youtu.be/")) {
    const videoId = url.split("youtu.be/")[1].split("?")[0];
    return `https://www.youtube.com/embed/${videoId}`;
  }
  if (url.includes("drive.google.com")) {
    const match = url.match(/\/d\/(.*)\/view/);
    if (match && match[1]) return `https://drive.google.com/file/d/${match[1]}/preview`;
  }
  if (url.includes("facebook.com")) {
    return `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=0&width=560`;
  }
  if (url.includes("tiktok.com")) {
    if (url.includes("/video/")) return `https://www.tiktok.com/embed/v2/${url.split("/video/")[1].split("?")[0]}`;
  }
  if (url.endsWith(".mp4")) return url;
  return url;
}

function createVideoPlayer(url) {
  const embedUrl = getEmbedUrl(url);
  if (embedUrl.endsWith(".mp4")) {
    return `<video controls width="100%" class="rounded-lg">
              <source src="${embedUrl}" type="video/mp4">
              Your browser does not support HTML5 video.
            </video>`;
  } else {
    return `<iframe width="100%" height="315" 
              src="${embedUrl}" frameborder="0" allowfullscreen
              class="rounded-lg"></iframe>`;
  }
}

/* ================= VIDEO LOAD ================= */
async function loadVideos() {
  const res = await fetch(`${SHEET_API}?sheet=videos`);
  videos = await res.json();
  renderVideos();
}

function renderVideos() {
  const list = document.getElementById("videoList");
  list.innerHTML = "";
  videos.forEach(v => {
    const div = document.createElement("div");
    div.className = "bg-white p-2 rounded shadow relative";

    let deleteBtn = "";
    if (currentUser && currentUser.email === ADMIN_EMAIL) {
      deleteBtn = `<button onclick="deleteVideo('${v.id}')" 
                    class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded">
                    üóëÔ∏è Delete</button>`;
    }

    div.innerHTML = `
      ${deleteBtn}
      <h2 class="font-bold mb-2">${v.title}</h2>
      ${createVideoPlayer(v.link)}
    `;
    div.onclick = (e) => {
      if (e.target.tagName !== "BUTTON") addToHistory(v);
    };
    list.appendChild(div);
  });
}

/* ================= SEARCH ================= */
function searchVideos() {
  const query = document.getElementById("searchInput").value.toLowerCase();
  const results = videos.filter(v => v.title.toLowerCase().includes(query));
  const list = document.getElementById("searchResults");
  list.innerHTML = "";
  results.forEach(v => {
    const div = document.createElement("div");
    div.className = "bg-white p-2 rounded shadow";
    div.innerHTML = `
      <h2 class="font-bold mb-2">${v.title}</h2>
      ${createVideoPlayer(v.link)}
    `;
    div.onclick = () => addToHistory(v);
    list.appendChild(div);
  });
}

/* ================= HISTORY ================= */
function addToHistory(video) {
  if (!currentUser) return;
  historyData.push({title: video.title, link: video.link, time: new Date().toISOString()});
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById("historyList");
  list.innerHTML = "";
  historyData.forEach(h => {
    const div = document.createElement("div");
    div.className = "bg-white p-2 rounded shadow";
    div.innerHTML = `
      <p class="font-bold">${h.title}</p>
      ${createVideoPlayer(h.link)}
      <p class="text-sm text-gray-500">Watched: ${new Date(h.time).toLocaleString()}</p>
    `;
    list.appendChild(div);
  });
}

/* ================= GOOGLE LOGIN ================= */
function handleCredentialResponse(response) {
  const data = parseJwt(response.credential);
  currentUser = {
    name: data.name,
    email: data.email,
    id: Math.floor(Math.random()*1000000)
  };
  renderProfile();
}

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  return JSON.parse(window.atob(base64));
}

function renderProfile() {
  const div = document.getElementById("profileContent");
  if (!currentUser) {
    div.innerHTML = `
      <div class="flex flex-col items-center">
        <p class="text-gray-500 mb-4">Sign in to view your profile and the Admin Dashboard.</p>
        <button id="signInButton" class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700">
          Sign in with Google
        </button>
      </div>
    `;
    document.getElementById('signInButton').addEventListener('click', () => {
      window.google.accounts.id.prompt();
    });
    return;
  }
  if (currentUser.email === ADMIN_EMAIL) {
    div.innerHTML = `
      <h2 class="font-bold">Admin Dashboard</h2>
      <p>${currentUser.name} (${currentUser.email})</p>
      <h3 class="mt-4 font-bold">Upload Video</h3>
      <input id="vtitle" placeholder="Title" class="border p-1 w-full mb-2">
      <input id="vlink" placeholder="Link" class="border p-1 w-full mb-2">
      <input id="vcat" placeholder="Category" class="border p-1 w-full mb-2">
      <button onclick="uploadVideo()" class="bg-indigo-600 text-white px-4 py-2 rounded">Upload</button>
      <div id="uploadStatus" class="mt-2 text-sm"></div>
    `;
  } else {
    div.innerHTML = `
      <h2 class="font-bold">User Dashboard</h2>
      <p>Name: ${currentUser.name}</p>
      <p>Email: ${currentUser.email}</p>
      <p>ID: ${currentUser.id}</p>
    `;
  }
}

/* ================= UPLOAD & DELETE ================= */
async function uploadVideo() {
  const title = document.getElementById("vtitle").value;
  const link = document.getElementById("vlink").value;
  const cat = document.getElementById("vcat").value;
  const id = Math.floor(Math.random()*1000000); // unique ID

  await fetch(`${SHEET_API}?sheet=videos`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify([{id, title, link, category:cat}])
  });

  document.getElementById("uploadStatus").innerText = "‚úÖ Uploaded!";
  loadVideos();
}

async function deleteVideo(videoId) {
  if (!confirm("Are you sure you want to delete this video?")) return;
  await fetch(`${SHEET_API}/id/${videoId}?sheet=videos`, {
    method: "DELETE"
  });
  loadVideos();
}

/* ================= INIT ================= */
window.onload = () => {
  loadVideos();
  renderProfile();
  window.google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredentialResponse
  });
};
</script>
</body>
</html>