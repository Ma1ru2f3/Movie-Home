<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moviebox</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:0; }
    header { background:#111; color:white; padding:10px; display:flex; justify-content:space-around; }
    header button { background:none; border:none; color:white; font-size:16px; cursor:pointer; }
    #content { padding:20px; }
    .video-card { display:inline-block; margin:10px; background:white; padding:10px; border-radius:5px; width:300px; vertical-align:top; }
    video { width:100%; border-radius:5px; }
    #adminPanel { display:none; margin-top:20px; background:#eee; padding:10px; border-radius:5px; }
    input, button { padding:5px; margin:5px; }
    .fav { color:red; cursor:pointer; float:right; font-weight:bold; }
  </style>
</head>
<body>

<header>
  <button id="homeBtn">Home</button>
  <button id="searchBtn">Search</button>
  <button id="favBtn">Favrt</button>
  <button id="profileBtn">Profile</button>
</header>

<div id="content">
  <div id="searchDiv" style="display:none;">
    <input type="text" id="searchInput" placeholder="Search video by title">
    <button id="searchGo">Search</button>
  </div>

  <div id="videoList"></div>

  <div id="adminPanel">
    <h3>Admin Upload</h3>
    <input type="text" id="videoTitle" placeholder="Enter title">
    <input type="file" id="videoFile">
    <button id="uploadBtn">Upload</button>
    <div id="progressDiv" style="display:none;">Uploading: <span id="progressText">0%</span></div>
  </div>
</div>

<script>
let videos = [];
let favs = JSON.parse(localStorage.getItem('favs') || '[]');

// Fetch all videos from server
async function loadVideos() {
  const res = await fetch('/videos');
  videos = await res.json();
  showVideos(videos);
}

function showVideos(list) {
  const videoList = document.getElementById('videoList');
  videoList.innerHTML = '';
  list.forEach(v => {
    const div = document.createElement('div');
    div.className = 'video-card';
    div.innerHTML = `
      <video src="${v.url}" controls></video>
      <h4>${v.title} <span class="fav" onclick="toggleFav('${v.public_id}','${v.url}','${v.title}')">${favs.find(f=>f.id===v.public_id)?'❤️':'♡'}</span></h4>
      <button onclick="deleteVideo('${v.public_id}')">Delete</button>
    `;
    videoList.appendChild(div);
  });
}

function toggleFav(id,url,title){
  const index = favs.findIndex(f=>f.id===id);
  if(index>=0){
    favs.splice(index,1);
  } else {
    favs.push({id,url,title});
  }
  localStorage.setItem('favs',JSON.stringify(favs));
  showVideos(videos);
}

// Delete video
async function deleteVideo(id){
  const user = prompt("Admin User:");
  const pass = prompt("Admin Pass:");
  const res = await fetch('/delete',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({public_id:id,user,pass})});
  if(res.ok){
    alert('Deleted!');
    loadVideos();
  }else{
    alert('Unauthorized');
  }
}

// Upload video
document.getElementById('uploadBtn').addEventListener('click', async ()=>{
  const file = document.getElementById('videoFile').files[0];
  const title = document.getElementById('videoTitle').value;
  const user = prompt("Admin User:");
  const pass = prompt("Admin Pass:");
  if(!file){ alert('Select file'); return; }
  const formData = new FormData();
  formData.append('video',file);
  formData.append('title',title);
  formData.append('user',user);
  formData.append('pass',pass);
  
  const progressDiv = document.getElementById('progressDiv');
  const progressText = document.getElementById('progressText');
  progressDiv.style.display='block';
  
  const xhr = new XMLHttpRequest();
  xhr.upload.addEventListener('progress', e=>{
    const percent = Math.round(e.loaded/e.total*100);
    progressText.innerText = percent+'%';
  });
  
  xhr.onreadystatechange = ()=>{
    if(xhr.readyState===4){
      progressDiv.style.display='none';
      if(xhr.status===200){
        alert('Upload Success!');
        loadVideos();
      }else{
        alert('Upload Failed');
      }
    }
  };
  
  xhr.open('POST','/upload');
  xhr.send(formData);
});

// Header buttons
document.getElementById('homeBtn').addEventListener('click',()=>{
  document.getElementById('searchDiv').style.display='none';
  document.getElementById('videoList').style.display='block';
  document.getElementById('adminPanel').style.display='none';
  showVideos(videos);
});

document.getElementById('searchBtn').addEventListener('click',()=>{
  document.getElementById('searchDiv').style.display='block';
  document.getElementById('videoList').style.display='block';
  document.getElementById('adminPanel').style.display='none';
});

document.getElementById('searchGo').addEventListener('click',()=>{
  const q = document.getElementById('searchInput').value.toLowerCase();
  showVideos(videos.filter(v=>v.title.toLowerCase().includes(q)));
});

document.getElementById('favBtn').addEventListener('click',()=>{
  document.getElementById('searchDiv').style.display='none';
  document.getElementById('videoList').style.display='block';
  document.getElementById('adminPanel').style.display='none';
  showVideos(favs);
});

document.getElementById('profileBtn').addEventListener('click',()=>{
  const user = prompt("Admin User:");
  const pass = prompt("Admin Pass:");
  if(user==='admin' && pass==='1234'){
    document.getElementById('adminPanel').style.display='block';
    document.getElementById('searchDiv').style.display='none';
  } else {
    alert('Unauthorized');
  }
});

loadVideos();
</script>
</body>
</html>