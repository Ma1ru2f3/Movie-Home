<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MovieBox</title>
<style>
body{font-family:sans-serif; margin:20px;}
video{width:300px; margin:10px;}
button{padding:5px 10px; margin:5px;}
#nav{margin-bottom:20px;}
#nav button{margin-right:10px;}
.favorite{color:red; cursor:pointer;}
</style>
</head>
<body>

<h1>MovieBox</h1>

<!-- Navigation -->
<div id="nav">
  <button onclick="showSection('home')">Home</button>
  <button onclick="showSection('favorites')">Favorites</button>
  <button onclick="showSection('profile')">Profile</button>
  <input type="text" id="searchInput" placeholder="Search..." oninput="searchVideos()">
</div>

<!-- Admin login -->
<div id="adminLogin">
  <input id="adminUser" placeholder="Admin ID">
  <input id="adminPass" type="password" placeholder="Password">
  <button onclick="loginAdmin()">Login</button>
</div>

<!-- Upload Section -->
<div id="uploadSection" style="display:none;">
  <h3>Upload Video</h3>
  <input type="file" id="videoFile">
  <input type="text" id="videoTitle" placeholder="Video Title">
  <button onclick="uploadVideo()">Upload</button>
  <p id="uploadStatus"></p>
</div>

<!-- Video Sections -->
<div id="homeSection">
  <h2>Home</h2>
  <div id="videoList"></div>
</div>

<div id="favoritesSection" style="display:none;">
  <h2>Favorites</h2>
  <div id="favoriteList"></div>
</div>

<div id="profileSection" style="display:none;">
  <h2>Profile</h2>
  <p>Profile UI placeholder</p>
</div>

<script>
let adminLogged = false;
let videos = [];
let favorites = [];
let currentSection = 'home';

// Admin login
function loginAdmin(){
  const user = document.getElementById('adminUser').value;
  const pass = document.getElementById('adminPass').value;
  fetch('/upload', {
    method:'POST',
    body: (() => {
      const fd = new FormData();
      fd.append('user',user);
      fd.append('pass',pass);
      fd.append('video', new Blob(['temp'])); // dummy for login check
      fd.append('title','test');
      return fd;
    })()
  }).then(res=>{
    if(res.status===401) alert("Invalid admin");
    else{
      adminLogged=true;
      document.getElementById('uploadSection').style.display='block';
      document.getElementById('adminLogin').style.display='none';
    }
  }).catch(err=>alert("Login check failed"));
}

// Upload video
async function uploadVideo(){
  if(!adminLogged) return alert("Login first");
  const file = document.getElementById('videoFile').files[0];
  const title = document.getElementById('videoTitle').value || file.name;
  const formData = new FormData();
  formData.append('video', file);
  formData.append('title', title);
  formData.append('user','admin');
  formData.append('pass','1234');

  const statusP = document.getElementById('uploadStatus');
  statusP.innerText="Uploading...";
  
  const res = await fetch('/upload',{method:'POST', body:formData});
  const data = await res.json();
  statusP.innerText="Upload Success";
  videos.push(data);
  renderVideos();
}

// Load all videos
async function loadVideos(){
  const res = await fetch("/videos");
  videos = await res.json();
  renderVideos();
}

// Render videos
function renderVideos(filtered=videos){
  const container = document.getElementById('videoList');
  container.innerHTML='';
  filtered.forEach(v=>{
    const div = document.createElement('div');
    const vid = document.createElement('video');
    vid.src=v.url;
    vid.controls=true;
    vid.width=300;
    const title = document.createElement('p');
    title.innerText=v.title;

    const favBtn = document.createElement('span');
    favBtn.innerText = favorites.includes(v.public_id)? '♥':'♡';
    favBtn.className = 'favorite';
    favBtn.onclick = ()=>toggleFavorite(v.public_id, favBtn);
    
    div.appendChild(title);
    div.appendChild(favBtn);
    div.appendChild(vid);
    container.appendChild(div);
  });
  renderFavorites();
}

// Favorites
function toggleFavorite(id, elem){
  if(favorites.includes(id)){
    favorites = favorites.filter(f=>f!==id);
    elem.innerText='♡';
  } else {
    favorites.push(id);
    elem.innerText='♥';
  }
  renderFavorites();
}

function renderFavorites(){
  const container = document.getElementById('favoriteList');
  container.innerHTML='';
  favorites.forEach(fid=>{
    const v = videos.find(vid=>vid.public_id===fid);
    if(v){
      const div = document.createElement('div');
      const vid = document.createElement('video');
      vid.src=v.url;
      vid.controls=true;
      vid.width=300;
      const title = document.createElement('p');
      title.innerText=v.title;
      div.appendChild(title);
      div.appendChild(vid);
      container.appendChild(div);
    }
  });
}

// Navigation
function showSection(section){
  currentSection = section;
  document.getElementById('homeSection').style.display= section==='home'? 'block':'none';
  document.getElementById('favoritesSection').style.display= section==='favorites'? 'block':'none';
  document.getElementById('profileSection').style.display= section==='profile'? 'block':'none';
}

// Search
function searchVideos(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = videos.filter(v=>v.title.toLowerCase().includes(q));
  renderVideos(filtered);
}

window.onload = loadVideos;
</script>

</body>
</html>